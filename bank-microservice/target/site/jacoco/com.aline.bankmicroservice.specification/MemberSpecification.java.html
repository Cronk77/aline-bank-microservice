<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MemberSpecification.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">bank-microservice</a> &gt; <a href="index.source.html" class="el_package">com.aline.bankmicroservice.specification</a> &gt; <span class="el_source">MemberSpecification.java</span></div><h1>MemberSpecification.java</h1><pre class="source lang-java linenums">package com.aline.bankmicroservice.specification;

import com.aline.bankmicroservice.dto.request.MemberSearchCriteria;
import com.aline.core.model.Applicant;
import com.aline.core.model.Applicant_;
import com.aline.core.model.Member;
import com.aline.core.model.Member_;
import com.aline.core.model.account.Account;
import com.aline.core.model.account.Account_;
import com.aline.core.model.account.CheckingAccount;
import com.aline.core.model.account.SavingsAccount;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.jpa.domain.Specification;

import javax.persistence.criteria.Join;
import javax.persistence.criteria.Path;
import java.text.MessageFormat;
import java.util.Locale;

<span class="fc" id="L20">@Slf4j(topic = &quot;Member Specifications&quot;)</span>
<span class="nc" id="L21">public class MemberSpecification {</span>

    public static Specification&lt;Member&gt; nameContains(String name) {
<span class="pc bpc" id="L24" title="2 of 4 branches missed.">        if (name == null || name.length() &lt;= 0) {</span>
<span class="nc" id="L25">            return null;</span>
        }
<span class="fc" id="L27">        return (root, criteriaQuery, criteriaBuilder) -&gt; {</span>
<span class="fc" id="L28">            Join&lt;Member, Applicant&gt; memberApplicantJoin = root.join(Member_.applicant);</span>
<span class="fc" id="L29">            return criteriaBuilder.or(</span>
<span class="fc" id="L30">                    criteriaBuilder.like(memberApplicantJoin.get(Applicant_.FIRST_NAME), contains(name)),</span>
<span class="fc" id="L31">                    criteriaBuilder.like(memberApplicantJoin.get(Applicant_.MIDDLE_NAME), contains(name)),</span>
<span class="fc" id="L32">                    criteriaBuilder.like(memberApplicantJoin.get(Applicant_.LAST_NAME), contains(name))</span>
            );
        };
    }

    public static Specification&lt;Member&gt; membershipOrApplicantIdContains(Long id) {
<span class="pc bpc" id="L38" title="1 of 2 branches missed.">        if (id == null) return null;</span>
<span class="fc" id="L39">        return ((root, criteriaQuery, criteriaBuilder) -&gt; {</span>
<span class="fc" id="L40">            Join&lt;Member, Applicant&gt; memberApplicantJoin = root.join(Member_.applicant);</span>

<span class="fc" id="L42">            return criteriaBuilder.or(</span>
<span class="fc" id="L43">                    criteriaBuilder.like(root.get(Member_.MEMBERSHIP_ID), contains(String.valueOf(id))),</span>
<span class="fc" id="L44">                    criteriaBuilder.like(memberApplicantJoin.get(Applicant_.ID).as(String.class), contains(String.valueOf(id)))</span>
            );
        });
    }

    public static Specification&lt;Member&gt; membersWithAccountStatus(String accountStatus) {
<span class="pc bpc" id="L50" title="2 of 4 branches missed.">        if (accountStatus == null || accountStatus.length() &lt;= 0) {</span>
<span class="nc" id="L51">            return null;</span>
        }
<span class="fc" id="L53">        return ((root, cq, cb) -&gt; {</span>
<span class="fc" id="L54">            Join&lt;Member, Account&gt; accountJoin = root.join(Member_.accounts);</span>
<span class="fc" id="L55">            return cb.equal(accountJoin.get(Account_.STATUS).as(String.class), accountStatus.toUpperCase(Locale.ROOT));</span>
        });
    }

    public static Specification&lt;Member&gt; membersAsPrimaryAccountHolder() {
<span class="fc" id="L60">        return ((root, criteriaQuery, criteriaBuilder) -&gt; {</span>
<span class="fc" id="L61">            criteriaQuery.distinct(true);</span>
<span class="fc" id="L62">            Join&lt;Member, Account&gt; memberAccountJoin = root.join(Member_.accounts);</span>
<span class="fc" id="L63">            Path&lt;Member&gt; primaryHolder = memberAccountJoin.join(Account_.primaryAccountHolder).get(Member_.MEMBERSHIP_ID);</span>
<span class="fc" id="L64">            return criteriaBuilder.equal(primaryHolder, root.get(Member_.MEMBERSHIP_ID));</span>
        }
        );
    }

    public static Specification&lt;Member&gt; membersWithCheckingAccounts() {
<span class="fc" id="L70">        return ((root, criteriaQuery, criteriaBuilder) -&gt; {</span>
<span class="fc" id="L71">            Join&lt;Member, Account&gt; memberAccountJoin = root.join(Member_.accounts);</span>
<span class="fc" id="L72">            return criteriaBuilder.equal(</span>
<span class="fc" id="L73">                    memberAccountJoin.type(), criteriaBuilder.literal(CheckingAccount.class)</span>
            );
        });
    }

    public static Specification&lt;Member&gt; membersWithSavingsAccounts() {
<span class="fc" id="L79">        return (((root, criteriaQuery, criteriaBuilder) -&gt; {</span>
<span class="fc" id="L80">            Join&lt;Member, Account&gt; memberAccountJoin = root.join(Member_.accounts);</span>
<span class="fc" id="L81">            return criteriaBuilder.equal(</span>
<span class="fc" id="L82">                    memberAccountJoin.type(), criteriaBuilder.literal(SavingsAccount.class)</span>
            );
        }));
    }

    public static Specification&lt;Member&gt; membersWithAccountsBalanceGreaterThanOrEqualTo(int startingAmt) {
<span class="fc" id="L88">        return ((root, criteriaQuery, criteriaBuilder) -&gt; {</span>
<span class="fc" id="L89">            Join&lt;Member, Account&gt; memberAccountJoin = root.join(Member_.accounts);</span>
<span class="fc" id="L90">            Path&lt;Member&gt; accountBalance = memberAccountJoin.get(Account_.BALANCE);</span>
<span class="fc" id="L91">            return criteriaBuilder.greaterThanOrEqualTo(accountBalance.as(Integer.class), startingAmt);</span>
        });
    }

    public static Specification&lt;Member&gt; membersWithAccountsBalanceLesserThanOrEqualTo(int endingAmt) {
<span class="fc" id="L96">        return ((root, criteriaQuery, criteriaBuilder) -&gt; {</span>
<span class="fc" id="L97">            Join&lt;Member, Account&gt; memberAccountJoin = root.join(Member_.accounts);</span>
<span class="fc" id="L98">            Path&lt;Member&gt; accountBalance = memberAccountJoin.get(Account_.BALANCE);</span>
<span class="fc" id="L99">            return criteriaBuilder.lessThanOrEqualTo(accountBalance.as(Integer.class), endingAmt);</span>
        });
    }

    public static Specification&lt;Member&gt; memberSearch(MemberSearchCriteria searchCriteria) {
<span class="fc" id="L104">        Specification&lt;Member&gt; searchSpecification = Specification.where(null);</span>

<span class="fc bfc" id="L106" title="All 2 branches covered.">        if (searchCriteria == null) {</span>
<span class="fc" id="L107">            return searchSpecification;</span>
        }

<span class="fc bfc" id="L110" title="All 2 branches covered.">        if (searchCriteria.getSearchName() != null) {</span>
<span class="fc" id="L111">            searchSpecification = searchSpecification.and(nameContains(searchCriteria.getSearchName()));</span>
        }
<span class="pc bpc" id="L113" title="1 of 2 branches missed.">        if (searchCriteria.getSearchId() != null) {</span>
<span class="nc" id="L114">            searchSpecification = searchSpecification.and(membershipOrApplicantIdContains(searchCriteria.getSearchId()));</span>
        }
<span class="pc bpc" id="L116" title="1 of 2 branches missed.">        if (searchCriteria.getAccountStatus() != null) {</span>
<span class="nc" id="L117">            searchSpecification = searchSpecification.and(membersWithAccountStatus(searchCriteria.getAccountStatus()));</span>
        }
<span class="pc bpc" id="L119" title="1 of 4 branches missed.">        if (searchCriteria.getIsPrimary() != null &amp;&amp; searchCriteria.getIsPrimary()) {</span>
<span class="fc" id="L120">            searchSpecification = searchSpecification.and(membersAsPrimaryAccountHolder());</span>
        }
<span class="fc bfc" id="L122" title="All 4 branches covered.">        if (searchCriteria.getHasChecking() != null &amp; Boolean.TRUE.equals(searchCriteria.getHasChecking())) {</span>
<span class="fc" id="L123">            searchSpecification = searchSpecification.and(membersWithCheckingAccounts());</span>
        }
<span class="pc bpc" id="L125" title="2 of 4 branches missed.">        if (searchCriteria.getHasSavings() != null &amp; Boolean.TRUE.equals(searchCriteria.getHasSavings())) {</span>
<span class="nc" id="L126">            searchSpecification = searchSpecification.and(membersWithSavingsAccounts());</span>
        }

<span class="fc" id="L129">        return searchSpecification;</span>
    }

    private static String contains(String expression) {
<span class="fc" id="L133">        return MessageFormat.format(&quot;%{0}%&quot;, expression);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>